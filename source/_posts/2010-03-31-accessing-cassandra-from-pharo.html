---
layout: post
title: Accessing Cassandra from Pharo
categories: []
tags:
- cassandra
- pharo
- thrift
status: publish
type: post
published: true
meta:
  _edit_last: '2'
---
<a href="http://nosql.mypopescu.com/">NoSQL</a> databases are the topic of the day anywhere in the web.

So this is good time to put a tutorial for accessing a Cassandra database from a Pharo Smalltalk image using the Thrift interface (there isn't a high-level client for accessing Cassandra from Pharo yet). Following instructions were tested on a Debian GNU/Linux Squeeze (testing) amd64 laptop.

<strong>Install the required dependencies
</strong>

As root:

<code>aptitude install libboost-dev automake libtool flex bison pkg-config g++ build-essential ruby-dev python-dev</code>

<strong>Create a working directory</strong>

As normal user create a working directory (I use my home directory)
<code>
mkdir /home/miguel/cassandra
cd /home/miguel/cassandra</code>

<strong>Get the thrift svn trunk source code</strong>.

<span style="text-decoration: line-through;">The current tar.gz package on the download page of <a href="http://incubator.apache.org/thrift/">Thift</a> doesn't include the necessary fixes.</span>

<span style="text-decoration: line-through;"><code>svn co http://svn.apache.org/repos/asf/incubator/thrift/trunk thrift</code></span>

Update: When this post was originally written, the patch I did for generating correct code for smalltalk wasn't part of a released version of thrift, that is the reason you had to get it from subversion trunk. But now is integrated and proper releases are out so there is no need to get thrift from svn, you can just get the tar.gz package from the thift download page (currently version 0.4.0):

<code>http://incubator.apache.org/thrift/download/</code>

uncompress the tar.gz and you'll get a folder named (in my case):

<code>thrift-0.4.0/</code>

<strong>Get the cassandra code</strong>

Go to http://cassandra.apache.org and download 0.5.1 version of <a href="http://cassandra.apache.org/">Cassandra</a> (here is the mirror I got, yours will likely be different):

<code>wget http://www.devlib.org/apache/cassandra/0.5.1/apache-cassandra-0.5.1-bin.tar.gz
tar zxf apache-cassandra-0.5.1-bin.tar.gz</code>

<strong>Get a Pharo image</strong>

Go to http://www.pharo-project.org/pharo-download/ and download a Pharo dev or a PharoCore image. I use a PharoCore RC3 image:

<code>wget https://gforge.inria.fr/frs/download.php/26668/PharoCore-1.0-10515rc3.zip
unzip PharoCore-1.0-10515rc3.zip</code>

You now have Thrift, Cassandra and Pharo ready to use.

<strong>Compile the Thrift source code</strong>

<code><span style="text-decoration: line-through;">cd thrift/</span></code>

<code>
cd thrift-0.4.0/
./bootstrap.sh
./configure
make</code>

<strong>Generate the Smalltalk Thrift code for accessing Cassandra</strong>

<code>cd ..
<span style="text-decoration: line-through;">./thrift/compiler/cpp/thrift --gen st apache-cassandra-0.5.1/interface/cassandra.thrift</span>
./thrift-0.4.0/compiler/cpp/thrift --gen st apache-cassandra-0.5.1/interface/cassandra.thrift
</code>

This will generate the file:

<code>gen-st/cassandra.st</code>

in the /home/miguel/cassandra directory (your working directory).

You now have two Smalltalk files:

<code>thrift/lib/st/thrift.st
gen-st/cassandra.st</code>

<strong>Load the Smalltalk Thrift code in the Pharo image</strong>

Open the Pharo image and file-in the two previous files in that order (first thrift.st and then cassandra.st)

<strong>Start and test the Cassandra server</strong>

If you have already a Cassandra node, skip this step. If you are testing, stay with me.

<code>cd apache-cassandra-0.5.1/</code>

Edit conf/log4.properties, change the line:

<code>log4j.appender.R.File=/var/log/cassandra/system.log</code>

to:

<code>log4j.appender.R.File=/home/miguel/cassandra/var/log/cassandra/system.log</code>

Edit conf/storage-conf.xml, change the lines:

<code>&lt;CommitLogDirectory&gt;/var/lib/cassandra/commitlog&lt;/CommitLogDirectory&gt;
&lt;DataFileDirectories&gt;
&lt;DataFileDirectory&gt;/var/lib/cassandra/data&lt;/DataFileDirectory&gt;
&lt;/DataFileDirectories&gt;
&lt;CalloutLocation&gt;/var/lib/cassandra/callouts&lt;/CalloutLocation&gt;
&lt;StagingFileDirectory&gt;/var/lib/cassandra/staging&lt;/StagingFileDirectory&gt;</code>

to:

<code>&lt;CommitLogDirectory&gt;/home/miguel/cassandra/var/lib/cassandra/commitlog&lt;/CommitLogDirectory&gt;
&lt;DataFileDirectories&gt;
&lt;DataFileDirectory&gt;/home/miguel/cassandra/var/lib/cassandra/data&lt;/DataFileDirectory&gt;
&lt;/DataFileDirectories&gt;
&lt;CalloutLocation&gt;/home/miguel/cassandra/var/lib/cassandra/callouts&lt;/CalloutLocation&gt;
&lt;StagingFileDirectory&gt;/home/miguel/cassandra/var/lib/cassandra/staging&lt;/StagingFileDirectory&gt;</code>

Then start the Cassandra server:

<code>./bin/cassandra -f</code>

Connect with the Cassandra provided client (Cassandra started on port 9160):

<code>./bin/cassandra-cli --host localhost --port 9160</code>

Insert a value:

<code>set Keyspace1.Standard1['jsmith']['first'] = 'John'</code>

Read back the value:

<code>get Keyspace1.Standard1['jsmith']</code>

<strong>Connect from Pharo to the Cassandra server</strong>

Open a workspace and try inserting 10000 values in the Cassandra server:

<code>
"Insert 10000 values"
[| cp result client |
client := CassandraClient binaryOnHost: 'localhost' port: 9160.
cp := ColumnPath new
columnFamily: 'Standard1';
column: 'col1'.
1 to: 10000 do: [ :i |
result := client insertKeyspace: 'Keyspace1'
key: 'row', i asString
columnPath: cp
value: 'v', i asString
timestamp: 1
consistencyLevel: ((Cassandra enums at: 'ConsistencyLevel') at: 'QUORUM').]] timeToRun</code>

Select the code and "print it". It took 7326 milliseconds in my laptop.

Now read the values from the Cassandra server:

<code>
"Read 10000 values"
[| cp result client |
client := CassandraClient binaryOnHost: 'localhost' port: 9160.
cp := ColumnPath new
columnFamily: 'Standard1';
column: 'col1'.</code>

1 to: 10000 do: [ :i |
result := client getKeyspace: 'Keyspace1'
key: 'row', i asString
columnPath: cp
consistencyLevel: ((Cassandra enums at: 'ConsistencyLevel') at: 'QUORUM').]] timeToRun

Select it and "print it". It took 7977 milliseconds to read back the 10000 values.

Read a value from the cassandra-cli interface:

<code>get Keyspace1.Standard1['row999']</code>

you should get:
<code>
cassandra&gt; get Keyspace1.Standard1['row999']
=&gt; (column=col1, value=v999, timestamp=1)
Returned 1 results.
</code>

That is it. Adapt the code to your needs.

Cheers
